Можно взять сетку мельче и посчитать интеграл по ней.
Рассмотрели треугольник, нарисовали средние линии, вычислили скалярное произведение
$$
(\varphi A, f)=\frac{1}{192}h_x h_y (6 f_A + f_B + f_C + 10 f_D + 4f_E + 10f_F)
$$
![[IMG_9821.jpg]]
![[IMG_9822.jpg]]
Из этого хорошо видно, что объём пирамиды равен 1, а значит всё хорошо
``` cpp
#define F(I, J) (f(a + (I) * h_x, c + (J) * h_y))

double F_ij (
	int nx,
	int ny,
	double hx,	
	double hy,
	double a,
	double c,
	int i,	
	int j,
	double (*f) (double x, double y)	
) {
	double w = hx * hy / 192; // ввели вес

	if (i > 0 && i < nx && i > 0 && i < ny) { // внутренние
		return w * (36 * F(i, j) 
				+ 20 * 
				(
					F(i + 0.5, j) + F(i, j - 0.5)
					+ F(i - 0.5, j - 0.5) + F(i - 0.5, j)
					+ F(i, j + 0.5) + F(i + 0.5, j + 0.5)
				)
				+ 4 *
				(
					F(i + 0.5, j - 0.5) + F(i - 0.5, j)
					+ F(i - 1, j - 0.5) + F(i - 0.5, j + 0.5)
					+ F(i + 0.5, j + 1) + F(i + 1, j + 0.5)
				)
				+ 2 *
				(
					F(i + 1, j) + F(i, j - 1)
					+ F(i - 1, j - 1) + F(i - 1, j)
					+ F(i, j + 1) + F(i + 1, j + 1)
				)
			);
	}

	if (i > 0 && i < n && j == 0) { //  нижняя сторона
		return w *
		(
			18 * F(i, j) +
			10 * (F(i + 0.5, j) + F(i - 0.5, j)) +
			20 * (F(i, j + 0.5) + F(i + 0.5, j + 0.5)) +
			 4 * (
				F(i - 0.5, j + 0,5) + 
				F(i + 0.5, j + 1) + 
				F(i + 1, j + 0.5)
			 ) + 
			 1 * (F(i - 1, j) + F(i + 1, j)) +
			 2 * (F(i, j + 1) + F(i + 1, j + 1))
		);
	}

	if (i > 0 && i < nx && j == ny) { // верхняя сторона
		return w * (
			18 * F(i, j) +
			10 * (F(i - 0.5, j) + F(i + 0.5, j)) +
			20 * (F(i, j - 0.5) + F(i - 0.5, j - 0.5)) +
			 4 * (
				F(i - 1, j - 0,5) + 
				F(i - 0.5, j - 1) + 
				F(i + 0.5, j - 0.5)
			 ) + 
			 1 * (F(i - 1, j) + F(i + 1, j)) +
			 2 * (F(i - 1, j - 1) + F(i, j - 1))
		);
	}

	if (i == 0 && j > 0 && j < ny) { // левая сторона без углов
		return w * (
			18 * F(i, j) +
			10 * (F(i, j - 0.5) + F(i, j + 0.5)) +
			20 * (F(i + 0.5, j) + F(i + 0.5, j + 0.5)) +
			 4 * ( 
				F(i + 0.5, j - 0.5) + 
				F(i + 0.5, j + 1)
				F(i + 1, j + 0,5) +
			 ) + 
			 1 * (F(i, j - 1) + F(i, j + 1)) +
			 2 * (F(i + 1, j) + F(i + 1, j + 1))
		);
	}

	if (i == nx && j > 0 && j < ny) { // правая сторона без углов
		return w * (
			18 * F(i, j) +
			10 * (F(i, j - 0.5) + F(i, j + 0.5)) +
			20 * (F(i - 0.5, j) + F(i - 0.5, j - 0.5)) +
			 4 * (
				F(i - 0.5, j - 1) + 
				F(i - 1, j - 0.5) + 
				F(i - 0.5, j + 0.5)
			 ) + 
			 1 * (F(i, j - 1) + F(i, j + 1)) +
			 2 * (F(i - 1, j - 1) + F(i - 1, j))
		);
	}

	if (i == 0 && j == 0) { // левый нижний угол
		return w * (
			12 * F(i, j) +
			10 * (F(i + 0.5, j) + F(i, j + 0.5)) +
			20 * F(i + 0.5, j + 0.5) +
			 4 * (F(i + 0.5, j + 1) + F(i + 1, j + 0.5)) + 
			 1 * (F(i + 1, j) + F(i, j + 1)) +
			 2 * (F(i + 1, j + 1))
		);
	}

	if (i == nx && j == ny) { // парвый верхний угол
		return w * (
			12 * F(i, j) +
			10 * (F(i - 0.5, j) + F(i, j - 0.5)) +
			20 * F(i - 0.5, j - 0.5) +
			 4 * (F(i - 0.5, j - 1) + F(i - 1, j - 0.5)) + 
			 1 * (F(i - 1, j) + F(i, j - 1)) +
			 2 * (F(i - 1, j - 1))
		);
	}

	if (i == nx && j == ny) { // левый верхний угол
		return w * (
			 6 * F(i, j) +
			10 * (F(i + 0.5, j) + F(i, j - 0.5)) +
			 4 * F(i + 0.5, j - 0.5) + 
			 1 * (F(i + 1, j) + F(i, j - 1))
		);
	}

	if (i == nx && j == ny) { // правый нижний угол
		return w * (
			 6 * F(i, j) +
			10 * (F(i - 0.5, j) + F(i, j + 0.5)) +
			 4 * F(i - 0.5, j + 0.5) + 
			 1 * (F(i - 1, j) + F(i, j + 1))
		);
	}

	return 1e308; // типа ошибка. Сюда не должно быть попаданий
}
```
![[IMG_9823.jpg]]
![[IMG_9824.jpg]]
![[IMG_9825.jpg]]
![[IMG_9826.jpg]]
![[IMG_9828.jpg]]
![[IMG_9829.jpg]]
1)
$$
a_{ij} = (\varphi_i, \varphi_j) = (\varphi_j, \varphi_i) = a_{ji}
$$
Проблемы:
	a) не нашли в j-й строке индекс равный 0 => шаблон несимметричен
	б) $a_{ij} \neq a_{ji}$
2)
$$
S_i = \sum_{j \in S(A)}
$$
$$
\sum a_{ij} = \sum_j (\varphi_i, \varphi_j) = (\varphi_i,\sum_j  \varphi_j) = (\varphi_i, 1) = \sum \int \varphi
$$
$$
\sum_{j, (i, j) \in S(A) } a_{ij} = \frac{h_x h_y}{6}
$$
![[IMG_9830.jpg]]
![[IMG_9831.jpg]]
![[IMG_9832.jpg]]
![[IMG_9833.jpg]]
![[IMG_9834.jpg]]
![[IMG_9836.jpg]]
![[IMG_9839.jpg]]
![[IMG_9840.jpg]]
2) Предобуславливатель зависит от числа потоков